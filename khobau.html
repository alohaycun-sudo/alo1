<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game ƒê√†o ƒê√° - Khai Th√°c Kho B√°u & Giao D·ªãch</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #FF6B35;
            --secondary-color: #004E89;
            --accent-color: #FFD166;
            --dark-color: #1A1A2E;
            --light-color: #F8F9FA;
            --success-color: #06D6A0;
            --danger-color: #EF476F;
            --market-color: #9D4EDD;
        }

        body {
            background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            color: var(--light-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 10px;
            margin: 0 auto;
        }

        /* Header styles */
        .header {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 28px;
            color: var(--accent-color);
        }

        .logo h1 {
            font-size: 20px;
            background: linear-gradient(to right, #FF6B35, #FFD166);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .balance {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            white-space: nowrap;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            text-align: center;
            padding: 12px 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .tab.active {
            background: var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Market Container */
        .market-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: var(--accent-color);
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-title h3 {
            font-size: 18px;
        }

        /* Market Tabs */
        .market-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .market-tab {
            flex: 1;
            min-width: 100px;
            text-align: center;
            padding: 12px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .market-tab.active {
            background: var(--market-color);
            font-weight: bold;
        }

        .market-content {
            display: none;
        }

        .market-content.active {
            display: block;
        }

        /* Create Listing Form - FIXED */
        .create-listing-form {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--accent-color);
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--market-color);
            box-shadow: 0 0 0 2px rgba(157, 78, 221, 0.3);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Buttons */
        .btn {
            padding: 14px 20px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(to right, var(--primary-color), #FF8E53);
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-market {
            background: linear-gradient(to right, var(--market-color), #7B2CBF);
        }

        .btn-market:hover {
            box-shadow: 0 5px 15px rgba(157, 78, 221, 0.4);
        }

        .btn-success {
            background: linear-gradient(to right, var(--success-color), #0ABF7C);
        }

        .btn-secondary {
            background: linear-gradient(to right, var(--secondary-color), #0066CC);
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
        }

        /* Market Listings */
        .market-listings {
            max-height: 400px;
            overflow-y: auto;
        }

        .market-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-select {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 14px;
        }

        /* Listing Item */
        .listing-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            flex-wrap: wrap;
            gap: 15px;
        }

        .listing-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .listing-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .item-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .listing-details {
            flex: 1;
            min-width: 150px;
        }

        .listing-details div {
            margin-bottom: 5px;
        }

        .listing-price {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 18px;
            white-space: nowrap;
        }

        .listing-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Empty State */
        .no-listings {
            text-align: center;
            padding: 40px 20px;
            color: #AAA;
            font-style: italic;
        }

        .no-listings i {
            font-size: 48px;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.2);
        }

        /* Stats */
        .market-stats {
            font-size: 14px;
            color: #AAA;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.5s ease;
            max-width: 300px;
            font-size: 14px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--accent-color);
            color: #333;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 15px;
            color: #AAA;
            font-size: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            line-height: 1.5;
        }

        .footer a {
            color: var(--accent-color);
            text-decoration: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .listing-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .listing-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .tab {
                min-width: 80px;
                padding: 10px 5px;
                font-size: 12px;
            }
            
            .market-tab {
                min-width: 80px;
                padding: 10px 5px;
                font-size: 12px;
            }
            
            .section-title {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .balance {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .market-filters {
                flex-direction: column;
            }
            
            .filter-select {
                width: 100%;
            }
            
            .tabs {
                flex-wrap: nowrap;
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }
            
            .market-tabs {
                flex-wrap: nowrap;
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Scrollbar Styling */
        .market-listings::-webkit-scrollbar {
            width: 6px;
        }

        .market-listings::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .market-listings::-webkit-scrollbar-thumb {
            background: var(--market-color);
            border-radius: 3px;
        }

        /* Item Colors */
        .worm { background: radial-gradient(circle, #8B4513, #654321); color: #FFF; }
        .gold { background: radial-gradient(circle, #FFD700, #FFA500); color: #FFF; }
        .silver { background: radial-gradient(circle, #C0C0C0, #A9A9A9); color: #333; }
        .diamond { background: radial-gradient(circle, #4EE2EC, #2AB7CA); color: #FFF; }
        .corpse { background: radial-gradient(circle, #708090, #2F4F4F); color: #FFF; }
        .mouse { background: radial-gradient(circle, #A0522D, #8B4513); color: #FFF; }
        .grass { background: radial-gradient(circle, #7CFC00, #32CD32); color: #FFF; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-gem"></i>
                <h1>ƒê√ÄO ƒê√Å PRO<br><span style="font-size: 12px;">Khai th√°c & Giao d·ªãch</span></h1>
            </div>
            <div class="user-info">
                <div class="balance" id="userBalance">
                    <i class="fas fa-coins"></i>
                    <span id="balanceAmount">113</span> xu
                </div>
                <button class="btn btn-secondary btn-sm" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <div class="tab active" data-tab="game">ƒê√†o ƒë√°</div>
            <div class="tab" data-tab="inventory">Kho ƒë·ªì</div>
            <div class="tab" data-tab="market">Ch·ª£ giao d·ªãch</div>
            <div class="tab" data-tab="leaderboard">X·∫øp h·∫°ng</div>
            <div class="tab" data-tab="chat">Tr√≤ chuy·ªán</div>
        </div>

        <!-- Market Tab -->
        <div class="tab-content active" id="marketTab">
            <div class="market-container">
                <div class="section-title">
                    <h3><i class="fas fa-store"></i> Ch·ª£ giao d·ªãch</h3>
                    <div class="market-stats" id="marketStats">ƒêang c√≥ 0 tin rao b√°n</div>
                </div>
                
                <div class="market-tabs">
                    <div class="market-tab active" data-market-tab="browse">Duy·ªát tin rao</div>
                    <div class="market-tab" data-market-tab="myListings">Tin c·ªßa t√¥i</div>
                    <div class="market-tab" data-market-tab="create">ƒêƒÉng tin m·ªõi</div>
                </div>
                
                <!-- Browse Listings -->
                <div class="market-content active" id="browseListings">
                    <div class="market-filters">
                        <select class="filter-select" id="filterItem">
                            <option value="">T·∫•t c·∫£ v·∫≠t ph·∫©m</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <select class="filter-select" id="filterSort">
                            <option value="price_asc">Gi√°: Th·∫•p ƒë·∫øn cao</option>
                            <option value="price_desc">Gi√°: Cao ƒë·∫øn th·∫•p</option>
                            <option value="date_desc">M·ªõi nh·∫•t</option>
                            <option value="date_asc">C≈© nh·∫•t</option>
                        </select>
                        <button class="btn btn-sm" id="applyFiltersBtn">
                            <i class="fas fa-filter"></i> L·ªçc
                        </button>
                    </div>
                    
                    <div class="market-listings" id="marketListings">
                        <!-- Market listings will be dynamically added here -->
                    </div>
                </div>
                
                <!-- My Listings -->
                <div class="market-content" id="myListings">
                    <div class="market-listings" id="myListingsContainer">
                        <!-- My listings will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Create Listing - FIXED VERSION -->
                <div class="market-content" id="createListing">
                    <div class="create-listing-form">
                        <div class="form-group">
                            <label for="listingItem"><i class="fas fa-gem"></i> Ch·ªçn v·∫≠t ph·∫©m</label>
                            <select id="listingItem">
                                <option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="listingQuantity"><i class="fas fa-hashtag"></i> S·ªë l∆∞·ª£ng</label>
                                <input type="number" id="listingQuantity" min="1" value="1" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng">
                            </div>
                            <div class="form-group">
                                <label for="listingPrice"><i class="fas fa-coins"></i> Gi√° m·ªói c√°i (xu)</label>
                                <input type="number" id="listingPrice" min="1" value="10" placeholder="Nh·∫≠p gi√°">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="listingDescription"><i class="fas fa-file-alt"></i> M√¥ t·∫£ (t√πy ch·ªçn)</label>
                            <textarea id="listingDescription" placeholder="M√¥ t·∫£ v·ªÅ v·∫≠t ph·∫©m c·ªßa b·∫°n... V√≠ d·ª•: 'V√†ng ch·∫•t l∆∞·ª£ng cao, m·ªõi ƒë√†o s√°ng nay'"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-market" id="createListingBtn">
                                <i class="fas fa-paper-plane"></i> ƒêƒÉng b√°n ngay
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 12px; color: #AAA;">
                            <i class="fas fa-info-circle"></i> <strong>L∆∞u √Ω:</strong> V·∫≠t ph·∫©m s·∫Ω ƒë∆∞·ª£c tr·ª´ kh·ªèi kho c·ªßa b·∫°n khi ƒëƒÉng b√°n. B·∫°n c√≥ th·ªÉ h·ªßy tin b·∫•t c·ª© l√∫c n√†o.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Game ƒê√†o ƒê√° PRO &copy; 2023 - Phi√™n b·∫£n Database & Giao d·ªãch</p>
            <p>Li√™n h·ªá h·ªó tr·ª£: Telegram <a href="https://t.me/cskhh1">@cskhh1</a></p>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div id="notificationMessage">Th√¥ng b√°o!</div>
    </div>

    <script>
        // Item configurations
        const items = [
            { id: 'worm', name: 'Giun', icon: 'üêõ', color: '#8B4513', price: 3 },
            { id: 'gold', name: 'V√†ng', icon: 'ü•á', color: '#FFD700', price: 50 },
            { id: 'silver', name: 'B·∫°c', icon: 'ü•à', color: '#C0C0C0', price: 15 },
            { id: 'diamond', name: 'Kim c∆∞∆°ng', icon: 'üíé', color: '#4EE2EC', price: 100 },
            { id: 'corpse', name: 'X√°c ch·∫øt', icon: 'üíÄ', color: '#708090', price: 1 },
            { id: 'mouse', name: 'Chu·ªôt', icon: 'üêÅ', color: '#A0522D', price: 4 },
            { id: 'grass', name: 'C·ªè', icon: 'üåø', color: '#7CFC00', price: 0 }
        ];

        // Mock inventory (in real app, load from localStorage/database)
        const inventory = {
            worm: 5,
            gold: 2,
            silver: 3,
            diamond: 0,
            corpse: 10,
            mouse: 7,
            grass: 15
        };

        // Mock market listings
        let marketListings = [];

        // DOM Elements
        const balanceAmount = document.getElementById('balanceAmount');
        const logoutBtn = document.getElementById('logoutBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const marketTabs = document.querySelectorAll('.market-tab');
        const marketContents = document.querySelectorAll('.market-content');
        const marketStats = document.getElementById('marketStats');
        const filterItem = document.getElementById('filterItem');
        const filterSort = document.getElementById('filterSort');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const marketListingsContainer = document.getElementById('marketListings');
        const myListingsContainer = document.getElementById('myListingsContainer');
        const listingItem = document.getElementById('listingItem');
        const listingQuantity = document.getElementById('listingQuantity');
        const listingPrice = document.getElementById('listingPrice');
        const listingDescription = document.getElementById('listingDescription');
        const createListingBtn = document.getElementById('createListingBtn');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');

        // Initialize
        function init() {
            // Populate item filters
            populateItemFilters();
            
            // Load market listings
            loadMarketListings();
            
            // Load my listings
            loadMyListings();
            
            // Setup event listeners
            setupEventListeners();
            
            // Show welcome message
            showNotification('Ch√†o m·ª´ng ƒë·∫øn v·ªõi ch·ª£ giao d·ªãch!', 'success');
        }

        // Populate item filters
        function populateItemFilters() {
            // Clear existing options
            filterItem.innerHTML = '<option value="">T·∫•t c·∫£ v·∫≠t ph·∫©m</option>';
            listingItem.innerHTML = '<option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>';
            
            // Add items to filters
            items.forEach(item => {
                // For browse filter
                filterItem.innerHTML += `<option value="${item.id}">${item.icon} ${item.name}</option>`;
                
                // For create listing form
                const hasItem = inventory[item.id] > 0;
                const disabledAttr = !hasItem ? 'disabled' : '';
                const stockInfo = hasItem ? ` (C√≥ ${inventory[item.id]})` : ' (H·∫øt h√†ng)';
                listingItem.innerHTML += `<option value="${item.id}" ${disabledAttr}>${item.icon} ${item.name}${stockInfo}</option>`;
            });
        }

        // Load market listings
        function loadMarketListings() {
            // For demo, create some sample listings
            if (marketListings.length === 0) {
                marketListings = [
                    {
                        id: 'lst_1',
                        itemId: 'gold',
                        quantity: 2,
                        price: 55,
                        description: 'V√†ng ch·∫•t l∆∞·ª£ng cao',
                        seller: 'Ng∆∞·ªùi ch∆°i A',
                        createdAt: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                        sold: false,
                        cancelled: false
                    },
                    {
                        id: 'lst_2',
                        itemId: 'diamond',
                        quantity: 1,
                        price: 120,
                        description: 'Kim c∆∞∆°ng s√°ng ch√≥i',
                        seller: 'Ng∆∞·ªùi ch∆°i B',
                        createdAt: new Date(Date.now() - 7200000).toISOString(), // 2 hours ago
                        sold: false,
                        cancelled: false
                    },
                    {
                        id: 'lst_3',
                        itemId: 'worm',
                        quantity: 10,
                        price: 4,
                        description: 'Giun t∆∞∆°i, m·ªõi b·∫Øt',
                        seller: 'Ng∆∞·ªùi ch∆°i C',
                        createdAt: new Date(Date.now() - 1800000).toISOString(), // 30 minutes ago
                        sold: false,
                        cancelled: false
                    }
                ];
            }
            
            // Apply filters
            let filteredListings = [...marketListings];
            
            // Filter by item
            const selectedItem = filterItem.value;
            if (selectedItem) {
                filteredListings = filteredListings.filter(l => l.itemId === selectedItem);
            }
            
            // Filter out sold/cancelled listings
            filteredListings = filteredListings.filter(l => !l.sold && !l.cancelled);
            
            // Sort listings
            const sortOption = filterSort.value;
            switch (sortOption) {
                case 'price_asc':
                    filteredListings.sort((a, b) => a.price - b.price);
                    break;
                case 'price_desc':
                    filteredListings.sort((a, b) => b.price - a.price);
                    break;
                case 'date_desc':
                    filteredListings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'date_asc':
                    filteredListings.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
            }
            
            // Update stats
            marketStats.textContent = `ƒêang c√≥ ${filteredListings.length} tin rao b√°n`;
            
            // Display listings
            displayListings(filteredListings, marketListingsContainer);
        }

        // Load my listings
        function loadMyListings() {
            // Filter listings for current user (in real app, use actual username)
            const myListings = marketListings.filter(l => l.seller === 'CurrentUser' && !l.sold && !l.cancelled);
            
            if (myListings.length === 0) {
                myListingsContainer.innerHTML = `
                    <div class="no-listings">
                        <i class="fas fa-clipboard-list"></i>
                        <p>B·∫°n ch∆∞a c√≥ tin rao b√°n n√†o!</p>
                        <p style="font-size: 12px; margin-top: 10px;">H√£y ƒëƒÉng tin b√°n v·∫≠t ph·∫©m c·ªßa b·∫°n</p>
                    </div>
                `;
                return;
            }
            
            displayListings(myListings, myListingsContainer, true);
        }

        // Display listings in container
        function displayListings(listings, container, isMyListings = false) {
            container.innerHTML = '';
            
            if (listings.length === 0) {
                container.innerHTML = `
                    <div class="no-listings">
                        <i class="fas fa-store-slash"></i>
                        <p>Kh√¥ng c√≥ tin rao b√°n n√†o!</p>
                        <p style="font-size: 12px; margin-top: 10px;">${isMyListings ? 'H√£y ƒëƒÉng tin b√°n v·∫≠t ph·∫©m c·ªßa b·∫°n' : 'H√£y quay l·∫°i sau'}</p>
                    </div>
                `;
                return;
            }
            
            listings.forEach(listing => {
                const item = items.find(i => i.id === listing.itemId);
                const totalPrice = listing.price * listing.quantity;
                const timeAgo = getTimeAgo(new Date(listing.createdAt));
                
                const listingElement = document.createElement('div');
                listingElement.className = 'listing-item';
                listingElement.innerHTML = `
                    <div class="listing-info">
                        <div class="item-icon ${listing.itemId}" style="background: ${item.color}">
                            ${item.icon}
                        </div>
                        <div class="listing-details">
                            <div style="font-weight: bold; font-size: 16px;">${item.name} √ó${listing.quantity}</div>
                            <div style="font-size: 12px; color: #AAA;">Ng∆∞·ªùi b√°n: ${listing.seller}</div>
                            <div style="font-size: 12px; color: #AAA;">${timeAgo}</div>
                            ${listing.description ? `<div style="font-size: 12px; margin-top: 5px; color: #DDD;">${listing.description}</div>` : ''}
                        </div>
                    </div>
                    <div class="listing-actions">
                        <div style="text-align: right;">
                            <div class="listing-price">${listing.price} xu/c√°i</div>
                            <div style="font-size: 12px; color: #AAA;">T·ªïng: ${totalPrice} xu</div>
                        </div>
                        ${isMyListings ? 
                            `<button class="btn btn-secondary btn-sm cancel-listing-btn" data-id="${listing.id}">
                                <i class="fas fa-times"></i> H·ªßy
                            </button>` : 
                            `<button class="btn btn-success btn-sm buy-listing-btn" data-id="${listing.id}">
                                <i class="fas fa-shopping-cart"></i> Mua
                            </button>`
                        }
                    </div>
                `;
                
                container.appendChild(listingElement);
            });
            
            // Add event listeners
            if (isMyListings) {
                document.querySelectorAll('.cancel-listing-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const listingId = this.getAttribute('data-id');
                        cancelListing(listingId);
                    });
                });
            } else {
                document.querySelectorAll('.buy-listing-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const listingId = this.getAttribute('data-id');
                        buyListing(listingId);
                    });
                });
            }
        }

        // Handle create listing
        function handleCreateListing() {
            const itemId = listingItem.value;
            const quantity = parseInt(listingQuantity.value);
            const price = parseInt(listingPrice.value);
            const description = listingDescription.value.trim();
            
            // Validation
            if (!itemId) {
                showNotification('Vui l√≤ng ch·ªçn v·∫≠t ph·∫©m!', 'error');
                return;
            }
            
            if (!quantity || quantity < 1) {
                showNotification('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!', 'error');
                return;
            }
            
            if (!price || price < 1) {
                showNotification('Gi√° ph·∫£i l·ªõn h∆°n 0 xu!', 'error');
                return;
            }
            
            // Check inventory
            const availableQuantity = inventory[itemId];
            if (availableQuantity < quantity) {
                const itemName = items.find(i => i.id === itemId).name;
                showNotification(`B·∫°n ch·ªâ c√≥ ${availableQuantity} ${itemName}, kh√¥ng ƒë·ªß s·ªë l∆∞·ª£ng!`, 'error');
                return;
            }
            
            // Create new listing
            const newListing = {
                id: 'lst_' + Date.now() + Math.random().toString(36).substr(2, 9),
                itemId: itemId,
                quantity: quantity,
                price: price,
                description: description,
                seller: 'CurrentUser', // In real app, use actual username
                createdAt: new Date().toISOString(),
                sold: false,
                cancelled: false
            };
            
            // Add to listings
            marketListings.push(newListing);
            
            // Deduct from inventory
            inventory[itemId] -= quantity;
            
            // Update UI
            populateItemFilters(); // Update available items
            loadMarketListings(); // Refresh browse listings
            loadMyListings(); // Refresh my listings
            
            // Switch to my listings tab
            switchMarketTab('myListings');
            
            // Show success message
            const item = items.find(i => i.id === itemId);
            showNotification(`ƒê√£ ƒëƒÉng b√°n ${quantity} ${item.name} v·ªõi gi√° ${price} xu/c√°i!`, 'success');
            
            // Reset form
            listingQuantity.value = 1;
            listingPrice.value = 10;
            listingDescription.value = '';
        }

        // Cancel listing
        function cancelListing(listingId) {
            const listingIndex = marketListings.findIndex(l => l.id === listingId);
            
            if (listingIndex === -1) {
                showNotification('Kh√¥ng t√¨m th·∫•y tin rao!', 'error');
                return;
            }
            
            const listing = marketListings[listingIndex];
            
            // Mark as cancelled
            marketListings[listingIndex].cancelled = true;
            
            // Return items to inventory
            inventory[listing.itemId] += listing.quantity;
            
            // Update UI
            populateItemFilters();
            loadMyListings();
            
            // Show success message
            const item = items.find(i => i.id === listing.itemId);
            showNotification(`ƒê√£ h·ªßy tin b√°n ${listing.quantity} ${item.name}!`, 'success');
        }

        // Buy listing
        function buyListing(listingId) {
            const listingIndex = marketListings.findIndex(l => l.id === listingId);
            
            if (listingIndex === -1) {
                showNotification('Kh√¥ng t√¨m th·∫•y tin rao!', 'error');
                return;
            }
            
            const listing = marketListings[listingIndex];
            const totalPrice = listing.price * listing.quantity;
            const currentBalance = parseInt(balanceAmount.textContent);
            
            // Check balance
            if (currentBalance < totalPrice) {
                showNotification(`B·∫°n c·∫ßn ${totalPrice} xu, hi·ªán c√≥ ${currentBalance} xu!`, 'error');
                return;
            }
            
            // Update balance
            const newBalance = currentBalance - totalPrice;
            balanceAmount.textContent = newBalance;
            
            // Mark as sold
            marketListings[listingIndex].sold = true;
            
            // Add to buyer's inventory (in real app, update database)
            // For demo, just show message
            
            // Update UI
            loadMarketListings();
            
            // Show success message
            const item = items.find(i => i.id === listing.itemId);
            showNotification(`Mua th√†nh c√¥ng ${listing.quantity} ${item.name} v·ªõi gi√° ${totalPrice} xu!`, 'success');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Market tab switching
            marketTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-market-tab');
                    switchMarketTab(tabId);
                    
                    // Refresh data when switching tabs
                    if (tabId === 'browse') {
                        loadMarketListings();
                    } else if (tabId === 'myListings') {
                        loadMyListings();
                    }
                });
            });
            
            // Apply filters
            applyFiltersBtn.addEventListener('click', loadMarketListings);
            
            // Create listing
            createListingBtn.addEventListener('click', handleCreateListing);
            
            // Logout button
            logoutBtn.addEventListener('click', () => {
                showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
                // In real app, redirect to login page
            });
            
            // Auto-suggest price based on item selection
            listingItem.addEventListener('change', function() {
                const selectedItem = items.find(i => i.id === this.value);
                if (selectedItem && selectedItem.price > 0) {
                    // Suggest price 20% higher than system price
                    const suggestedPrice = Math.ceil(selectedItem.price * 1.2);
                    listingPrice.value = suggestedPrice;
                    
                    // Update max quantity based on inventory
                    const maxQuantity = inventory[selectedItem.id];
                    listingQuantity.max = maxQuantity;
                    if (parseInt(listingQuantity.value) > maxQuantity) {
                        listingQuantity.value = maxQuantity;
                    }
                }
            });
            
            // Update quantity validation
            listingQuantity.addEventListener('input', function() {
                const selectedItem = listingItem.value;
                if (selectedItem) {
                    const maxQuantity = inventory[selectedItem];
                    if (parseInt(this.value) > maxQuantity) {
                        this.value = maxQuantity;
                        showNotification(`B·∫°n ch·ªâ c√≥ ${maxQuantity} v·∫≠t ph·∫©m n√†y!`, 'warning');
                    }
                }
            });
        }

        // Switch main tabs
        function switchTab(tabId) {
            // Update tabs
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Update tab contents
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabId}Tab`) {
                    content.classList.add('active');
                }
            });
        }

        // Switch market tabs
        function switchMarketTab(tabId) {
            // Update market tabs
            marketTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-market-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Update market contents
            marketContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId || content.id === `${tabId}Listings`) {
                    content.classList.add('active');
                }
            });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'V·ª´a xong';
            if (minutes < 60) return `${minutes} ph√∫t tr∆∞·ªõc`;
            if (hours < 24) return `${hours} gi·ªù tr∆∞·ªõc`;
            return `${days} ng√†y tr∆∞·ªõc`;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
