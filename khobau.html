<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game ƒê√†o ƒê√° - Khai Th√°c Kho B√°u & Giao D·ªãch</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #FF6B35;
            --secondary-color: #004E89;
            --accent-color: #FFD166;
            --dark-color: #1A1A2E;
            --light-color: #F8F9FA;
            --success-color: #06D6A0;
            --danger-color: #EF476F;
            --market-color: #9D4EDD;
        }

        body {
            background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            color: var(--light-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 10px;
            margin: 0 auto;
        }

        /* Header styles */
        .header {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 28px;
            color: var(--accent-color);
        }

        .logo h1 {
            font-size: 20px;
            background: linear-gradient(to right, #FF6B35, #FFD166);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        /* Auth forms */
        .auth-form {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(to right, var(--primary-color), #FF8E53);
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(to right, var(--secondary-color), #0066CC);
        }

        .btn-success {
            background: linear-gradient(to right, var(--success-color), #0ABF7C);
        }

        .btn-market {
            background: linear-gradient(to right, var(--market-color), #7B2CBF);
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
        }

        .switch-auth {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }

        .switch-auth a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: bold;
        }

        /* Game area */
        .game-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .depth-info {
            background: linear-gradient(to right, #0F3460, #1A1A2E);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .depth-meter {
            height: 20px;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .depth-fill {
            height: 100%;
            background: linear-gradient(to right, #4ECDC4, #44A08D);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .game-area {
            position: relative;
            height: 300px;
            background: linear-gradient(to bottom, #0F3460, #1A1A2E);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80%;
            background: linear-gradient(to top, #3A2C28, #553D36);
        }

        .miner {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 80px;
            transition: bottom 0.5s ease;
            z-index: 10;
        }

        .miner-body {
            width: 40px;
            height: 50px;
            background: #555;
            border-radius: 5px;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .miner-head {
            width: 30px;
            height: 30px;
            background: #FFD166;
            border-radius: 50%;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .miner-light {
            width: 15px;
            height: 15px;
            background: #FFD166;
            border-radius: 50%;
            position: absolute;
            top: -10px;
            left: 60%;
            box-shadow: 0 0 10px 5px rgba(255, 209, 102, 0.5);
        }

        .item {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            z-index: 5;
            opacity: 0;
            transform: scale(0);
            transition: opacity 0.3s, transform 0.3s;
        }

        .item.show {
            opacity: 1;
            transform: scale(1);
        }

        .worm { background: radial-gradient(circle, #8B4513, #654321); color: #FFF; }
        .gold { background: radial-gradient(circle, #FFD700, #FFA500); color: #FFF; }
        .silver { background: radial-gradient(circle, #C0C0C0, #A9A9A9); color: #333; }
        .diamond { background: radial-gradient(circle, #4EE2EC, #2AB7CA); color: #FFF; }
        .corpse { background: radial-gradient(circle, #708090, #2F4F4F); color: #FFF; }
        .mouse { background: radial-gradient(circle, #A0522D, #8B4513); color: #FFF; }
        .grass { background: radial-gradient(circle, #7CFC00, #32CD32); color: #FFF; }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(145deg, var(--primary-color), #FF8E53);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.5);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        /* Inventory */
        .inventory-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .inventory-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .inventory-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .item-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .item-count {
            font-weight: bold;
            font-size: 18px;
        }

        .item-price {
            font-size: 12px;
            color: var(--accent-color);
        }

        .item-actions {
            display: flex;
            gap: 5px;
            width: 100%;
        }

        .action-btn {
            flex: 1;
            padding: 5px;
            border-radius: 5px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3px;
        }

        .sell-btn {
            background: var(--success-color);
            color: white;
        }

        .list-btn {
            background: var(--market-color);
            color: white;
        }

        /* Market */
        .market-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .market-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .market-tab {
            flex: 1;
            min-width: 100px;
            text-align: center;
            padding: 12px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .market-tab.active {
            background: var(--market-color);
            font-weight: bold;
        }

        .market-content {
            display: none;
        }

        .market-content.active {
            display: block;
        }

        .market-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-select {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
        }

        .market-listings {
            max-height: 400px;
            overflow-y: auto;
        }

        .listing-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .listing-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .listing-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .listing-details {
            flex: 1;
        }

        .listing-seller {
            font-size: 12px;
            color: #AAA;
            margin-top: 5px;
        }

        .listing-price {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 18px;
        }

        .listing-actions {
            display: flex;
            gap: 10px;
        }

        .no-listings {
            text-align: center;
            padding: 30px;
            color: #AAA;
            font-style: italic;
        }

        /* FIXED: Create Listing Form */
        .create-listing-form {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .create-listing-form .form-group {
            margin-bottom: 20px;
        }

        .create-listing-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--accent-color);
            font-size: 14px;
        }

        .create-listing-form select,
        .create-listing-form input,
        .create-listing-form textarea {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .create-listing-form select:focus,
        .create-listing-form input:focus,
        .create-listing-form textarea:focus {
            outline: none;
            border-color: var(--market-color);
            box-shadow: 0 0 0 2px rgba(157, 78, 221, 0.3);
        }

        .create-listing-form textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
            min-width: 150px;
        }

        /* FIXED: Tabs kh√¥ng b·ªã ch√®n ch·ªØ */
        .tabs {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab {
            flex: 1;
            min-width: 95px;
            text-align: center;
            padding: 12px 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 13px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab.active {
            background: var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Leaderboard */
        .leaderboard-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-item.top-1 {
            background: linear-gradient(to right, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
            border-left: 5px solid #FFD700;
        }

        .leaderboard-item.top-2 {
            background: linear-gradient(to right, rgba(192, 192, 192, 0.3), rgba(192, 192, 192, 0.1));
            border-left: 5px solid #C0C0C0;
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(to right, rgba(205, 127, 50, 0.3), rgba(205, 127, 50, 0.1));
            border-left: 5px solid #CD7F32;
        }

        .rank {
            font-weight: bold;
            font-size: 20px;
            width: 30px;
            text-align: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .user-details {
            flex-grow: 1;
        }

        .user-name {
            font-weight: bold;
        }

        .user-stats {
            font-size: 12px;
            color: #AAA;
        }

        /* Chat */
        .chat-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 14px;
        }

        .chat-message .sender {
            font-weight: bold;
            color: var(--accent-color);
        }

        .chat-message .time {
            font-size: 10px;
            color: #AAA;
            float: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.5s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--accent-color);
            color: #333;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 15px;
            color: #AAA;
            font-size: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
        }

        .footer a {
            color: var(--accent-color);
            text-decoration: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
                padding: 20px;
            }
            
            .inventory-items {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .tabs {
                justify-content: flex-start;
            }
            
            .tab {
                min-width: 120px;
            }
        }

        @media (max-width: 480px) {
            .tab {
                min-width: 85px;
                font-size: 12px;
                padding: 10px 3px;
            }
            
            .market-tab {
                min-width: 90px;
                font-size: 12px;
                padding: 10px 5px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-row .form-group {
                min-width: 100%;
            }
        }

        /* Quantity info style */
        .quantity-info {
            font-size: 12px;
            margin-top: 5px;
            padding: 5px;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-gem"></i>
                <h1>ƒê√ÄO ƒê√Å PRO<br><span style="font-size: 12px;">Khai th√°c & Giao d·ªãch</span></h1>
            </div>
            <div class="user-info">
                <div class="balance" id="userBalance">
                    <i class="fas fa-coins"></i>
                    <span id="balanceAmount">0</span> xu
                </div>
                <button class="btn btn-secondary btn-sm" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>

        <!-- Authentication Forms -->
        <div class="auth-form active" id="loginForm">
            <h2><i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p</h2>
            <div class="form-group">
                <label for="loginUsername">T√™n ƒëƒÉng nh·∫≠p</label>
                <input type="text" id="loginUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
            </div>
            <div class="form-group">
                <label for="loginPassword">M·∫≠t kh·∫©u</label>
                <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
            </div>
            <button class="btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
            </button>
            <div class="switch-auth">
                Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" id="showRegister">ƒêƒÉng k√Ω ngay</a>
            </div>
        </div>

        <div class="auth-form" id="registerForm">
            <h2><i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω t√†i kho·∫£n</h2>
            <div class="form-group">
                <label for="registerUsername">T√™n ƒëƒÉng nh·∫≠p</label>
                <input type="text" id="registerUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
            </div>
            <div class="form-group">
                <label for="registerPassword">M·∫≠t kh·∫©u</label>
                <input type="password" id="registerPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
            </div>
            <div class="form-group">
                <label for="registerConfirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                <input type="password" id="registerConfirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">
            </div>
            <button class="btn btn-success" id="registerBtn">
                <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω
            </button>
            <div class="switch-auth">
                ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" id="showLogin">ƒêƒÉng nh·∫≠p ngay</a>
            </div>
        </div>

        <!-- Main Game Area (hidden until logged in) -->
        <div id="gameContent" style="display: none;">
            <!-- Tabs Navigation -->
            <div class="tabs">
                <div class="tab active" data-tab="game">ƒê√†o ƒë√°</div>
                <div class="tab" data-tab="inventory">Kho ƒë·ªì</div>
                <div class="tab" data-tab="market">Ch·ª£ giao d·ªãch</div>
                <div class="tab" data-tab="leaderboard">B·∫£ng x·∫øp h·∫°ng</div>
                <div class="tab" data-tab="chat">Tr√≤ chuy·ªán</div>
                <div class="tab" data-tab="transactions">L·ªãch s·ª≠ giao d·ªãch</div>
            </div>

            <!-- Game Tab -->
            <div class="tab-content active" id="gameTab">
                <div class="game-container">
                    <div class="depth-info">
                        <div>
                            <div>ƒê·ªô s√¢u hi·ªán t·∫°i: <span id="currentDepth">0</span>m</div>
                            <div class="depth-meter">
                                <div class="depth-fill" id="depthFill"></div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div>Khu v·ª±c: <span id="currentZone">0-100m</span></div>
                            <div style="font-size: 12px; color: #AAA;">T·ªâ l·ªá v·∫≠t ph·∫©m thay ƒë·ªïi theo ƒë·ªô s√¢u</div>
                        </div>
                    </div>

                    <div class="game-area" id="gameArea">
                        <div class="ground"></div>
                        <div class="miner" id="miner">
                            <div class="miner-head"></div>
                            <div class="miner-body"></div>
                            <div class="miner-light"></div>
                        </div>
                        <!-- Items will be dynamically added here -->
                    </div>

                    <div class="controls">
                        <button class="control-btn" id="digBtn">
                            <i class="fas fa-digging"></i>
                        </button>
                        <button class="control-btn" id="upBtn">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="control-btn" id="downBtn">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                </div>

                <!-- Prize Notification -->
                <div style="background: rgba(255, 215, 0, 0.2); padding: 10px; border-radius: 10px; margin-top: 15px; border-left: 5px solid #FFD700;">
                    <div style="font-weight: bold; color: #FFD700;">
                        <i class="fas fa-trophy"></i> PH·∫¶N TH∆Ø·ªûNG H·∫∞NG NG√ÄY
                    </div>
                    <div style="font-size: 12px; margin-top: 5px;">
                        Top 1: 50,000 VND | Top 2: 50,000 VND | Top 3: 50,000 VND
                    </div>
                    <div style="font-size: 10px; margin-top: 5px; color: #AAA;">
                        Li√™n h·ªá admin Telegram <a href="https://t.me/cskhh1" style="color: #0088cc; text-decoration: none;">@cskhh1</a> ƒë·ªÉ nh·∫≠n ti·ªÅn m·∫∑t v√†o ng√†y h√¥m sau
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div class="tab-content" id="inventoryTab">
                <div class="inventory-container">
                    <div class="section-title">
                        <h3><i class="fas fa-backpack"></i> Kho ƒë·ªì c·ªßa b·∫°n</h3>
                        <div>
                            <button class="btn btn-success btn-sm" id="sellAllBtn">
                                <i class="fas fa-money-bill-wave"></i> B√°n t·∫•t c·∫£
                            </button>
                            <button class="btn btn-market btn-sm" id="openCreateListingBtn">
                                <i class="fas fa-store"></i> ƒêƒÉng b√°n
                            </button>
                        </div>
                    </div>
                    <div class="inventory-items" id="inventoryItems">
                        <!-- Inventory items will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Market Tab - FIXED -->
            <div class="tab-content" id="marketTab">
                <div class="market-container">
                    <div class="section-title">
                        <h3><i class="fas fa-store"></i> Ch·ª£ giao d·ªãch</h3>
                        <div style="font-size: 12px; color: #AAA;" id="marketStats">ƒêang c√≥ 0 tin rao b√°n</div>
                    </div>
                    
                    <div class="market-tabs">
                        <div class="market-tab active" data-market-tab="browse">Duy·ªát tin rao</div>
                        <div class="market-tab" data-market-tab="myListings">Tin c·ªßa t√¥i</div>
                        <div class="market-tab" data-market-tab="create">ƒêƒÉng tin m·ªõi</div>
                    </div>
                    
                    <!-- Browse Listings -->
                    <div class="market-content active" id="browseListings">
                        <div class="market-filters">
                            <select class="filter-select" id="filterItem">
                                <option value="">T·∫•t c·∫£ v·∫≠t ph·∫©m</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <select class="filter-select" id="filterSort">
                                <option value="price_asc">Gi√°: Th·∫•p ƒë·∫øn cao</option>
                                <option value="price_desc">Gi√°: Cao ƒë·∫øn th·∫•p</option>
                                <option value="date_desc">M·ªõi nh·∫•t</option>
                                <option value="date_asc">C≈© nh·∫•t</option>
                            </select>
                            <button class="btn btn-sm" id="applyFiltersBtn">
                                <i class="fas fa-filter"></i> L·ªçc
                            </button>
                        </div>
                        
                        <div class="market-listings" id="marketListings">
                            <!-- Market listings will be dynamically added here -->
                        </div>
                    </div>
                    
                    <!-- My Listings -->
                    <div class="market-content" id="myListings">
                        <div class="market-listings" id="myListingsContainer">
                            <!-- My listings will be dynamically added here -->
                        </div>
                    </div>
                    
                    <!-- Create Listing - FIXED -->
                    <div class="market-content" id="createListing">
                        <div class="create-listing-form">
                            <div class="form-group">
                                <label for="listingItem"><i class="fas fa-gem"></i> Ch·ªçn v·∫≠t ph·∫©m</label>
                                <select id="listingItem">
                                    <!-- Options will be populated dynamically -->
                                </select>
                                <div class="quantity-info" id="quantityInfo"></div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="listingQuantity"><i class="fas fa-hashtag"></i> S·ªë l∆∞·ª£ng</label>
                                    <input type="number" id="listingQuantity" min="1" value="1" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng">
                                </div>
                                <div class="form-group">
                                    <label for="listingPrice"><i class="fas fa-coins"></i> Gi√° m·ªói c√°i (xu)</label>
                                    <input type="number" id="listingPrice" min="1" value="10" placeholder="Nh·∫≠p gi√° b√°n">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="listingDescription"><i class="fas fa-file-alt"></i> M√¥ t·∫£ (t√πy ch·ªçn)</label>
                                <textarea id="listingDescription" placeholder="M√¥ t·∫£ v·ªÅ v·∫≠t ph·∫©m c·ªßa b·∫°n..."></textarea>
                            </div>
                            
                            <button class="btn btn-market" id="createListingBtn">
                                <i class="fas fa-paper-plane"></i> ƒêƒÇNG B√ÅN NGAY
                            </button>
                            
                            <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 12px; color: #AAA; line-height: 1.5;">
                                <i class="fas fa-info-circle"></i> <strong>Th√¥ng tin:</strong> V·∫≠t ph·∫©m s·∫Ω ƒë∆∞·ª£c tr·ª´ kh·ªèi kho khi ƒëƒÉng b√°n. B·∫°n c√≥ th·ªÉ h·ªßy tin b·∫•t c·ª© l√∫c n√†o.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div class="tab-content" id="leaderboardTab">
                <div class="leaderboard-container">
                    <div class="section-title">
                        <h3><i class="fas fa-trophy"></i> B·∫£ng x·∫øp h·∫°ng</h3>
                        <div style="font-size: 12px; color: #AAA;">C·∫≠p nh·∫≠t theo th·ªùi gian th·ª±c</div>
                    </div>
                    <div class="leaderboard" id="leaderboard">
                        <!-- Leaderboard items will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div class="tab-content" id="chatTab">
                <div class="chat-container">
                    <div class="section-title">
                        <h3><i class="fas fa-comments"></i> Tr√≤ chuy·ªán</h3>
                        <div style="font-size: 12px; color: #AAA;" id="onlineCount">ƒêang online: 1</div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- Chat messages will be dynamically added here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n...">
                        <button class="btn btn-sm" id="sendChatBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div class="tab-content" id="transactionsTab">
                <div class="market-container">
                    <div class="section-title">
                        <h3><i class="fas fa-history"></i> L·ªãch s·ª≠ giao d·ªãch</h3>
                        <button class="btn btn-sm btn-secondary" id="refreshTransactionsBtn">
                            <i class="fas fa-sync-alt"></i> L√†m m·ªõi
                        </button>
                    </div>
                    <div class="market-listings" id="transactionsList">
                        <!-- Transactions will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Game ƒê√†o ƒê√° PRO &copy; 2023 - Phi√™n b·∫£n Database & Giao d·ªãch</p>
            <p>Li√™n h·ªá h·ªó tr·ª£: Telegram <a href="https://t.me/cskhh1">@cskhh1</a></p>
        </div>
    </div>

    <!-- Listing Detail Modal -->
    <div class="modal" id="listingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Chi ti·∫øt tin rao</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div id="modalContent">
                <!-- Modal content will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div id="notificationMessage">Th√¥ng b√°o!</div>
    </div>

    <script>
        // Game Database
        const GameDatabase = {
            users: JSON.parse(localStorage.getItem('miningGameUsers_v2')) || [],
            listings: JSON.parse(localStorage.getItem('miningGameListings')) || [],
            transactions: JSON.parse(localStorage.getItem('miningGameTransactions')) || [],
            chatMessages: JSON.parse(localStorage.getItem('miningGameChat_v2')) || [],
            leaderboard: JSON.parse(localStorage.getItem('miningGameLeaderboard_v2')) || [],
            
            saveUsers: function() {
                localStorage.setItem('miningGameUsers_v2', JSON.stringify(this.users));
            },
            
            saveListings: function() {
                localStorage.setItem('miningGameListings', JSON.stringify(this.listings));
            },
            
            saveTransactions: function() {
                localStorage.setItem('miningGameTransactions', JSON.stringify(this.transactions));
            },
            
            saveChat: function() {
                localStorage.setItem('miningGameChat_v2', JSON.stringify(this.chatMessages));
            },
            
            saveLeaderboard: function() {
                localStorage.setItem('miningGameLeaderboard_v2', JSON.stringify(this.leaderboard));
            },
            
            // User methods
            findUser: function(username) {
                return this.users.find(u => u.username === username);
            },
            
            updateUser: function(username, updates) {
                const userIndex = this.users.findIndex(u => u.username === username);
                if (userIndex !== -1) {
                    this.users[userIndex] = { ...this.users[userIndex], ...updates };
                    this.saveUsers();
                    return true;
                }
                return false;
            },
            
            // Listing methods
            addListing: function(listing) {
                this.listings.push(listing);
                this.saveListings();
            },
            
            removeListing: function(listingId) {
                this.listings = this.listings.filter(l => l.id !== listingId);
                this.saveListings();
            },
            
            findListing: function(listingId) {
                return this.listings.find(l => l.id === listingId);
            },
            
            updateListing: function(listingId, updates) {
                const listingIndex = this.listings.findIndex(l => l.id === listingId);
                if (listingIndex !== -1) {
                    this.listings[listingIndex] = { ...this.listings[listingIndex], ...updates };
                    this.saveListings();
                    return true;
                }
                return false;
            },
            
            // Transaction methods
            addTransaction: function(transaction) {
                this.transactions.push(transaction);
                this.saveTransactions();
            },
            
            getUserTransactions: function(username) {
                return this.transactions.filter(t => 
                    t.buyer === username || t.seller === username
                ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
        };

        // Game Data and State
        const gameState = {
            loggedIn: false,
            username: '',
            balance: 0,
            depth: 0,
            zone: '0-100m',
            inventory: {
                worm: 0,
                gold: 0,
                silver: 0,
                diamond: 0,
                corpse: 0,
                mouse: 0,
                grass: 0
            },
            itemPrices: {
                worm: 3,
                gold: 50,
                silver: 15,
                diamond: 100,
                corpse: 1,
                mouse: 4,
                grass: 0
            },
            baseRates: {
                worm: 80,
                gold: 10,
                silver: 20,
                diamond: 5,
                corpse: 89,
                mouse: 70,
                grass: 100
            },
            currentRates: {},
            mining: false
        };

        // Item configurations
        const items = [
            { id: 'worm', name: 'Giun', icon: 'üêõ', color: '#8B4513' },
            { id: 'gold', name: 'V√†ng', icon: 'ü•á', color: '#FFD700' },
            { id: 'silver', name: 'B·∫°c', icon: 'ü•à', color: '#C0C0C0' },
            { id: 'diamond', name: 'Kim c∆∞∆°ng', icon: 'üíé', color: '#4EE2EC' },
            { id: 'corpse', name: 'X√°c ch·∫øt', icon: 'üíÄ', color: '#708090' },
            { id: 'mouse', name: 'Chu·ªôt', icon: 'üêÅ', color: '#A0522D' },
            { id: 'grass', name: 'C·ªè', icon: 'üåø', color: '#7CFC00' }
        ];

        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const gameContent = document.getElementById('gameContent');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const balanceAmount = document.getElementById('balanceAmount');
        const currentDepth = document.getElementById('currentDepth');
        const depthFill = document.getElementById('depthFill');
        const currentZone = document.getElementById('currentZone');
        const gameArea = document.getElementById('gameArea');
        const miner = document.getElementById('miner');
        const digBtn = document.getElementById('digBtn');
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const inventoryItems = document.getElementById('inventoryItems');
        const sellAllBtn = document.getElementById('sellAllBtn');
        const openCreateListingBtn = document.getElementById('openCreateListingBtn');
        const leaderboard = document.getElementById('leaderboard');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const marketTabs = document.querySelectorAll('.market-tab');
        const marketContents = document.querySelectorAll('.market-content');
        const marketStats = document.getElementById('marketStats');
        const filterItem = document.getElementById('filterItem');
        const filterSort = document.getElementById('filterSort');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const marketListings = document.getElementById('marketListings');
        const myListingsContainer = document.getElementById('myListingsContainer');
        const listingItem = document.getElementById('listingItem');
        const listingQuantity = document.getElementById('listingQuantity');
        const listingPrice = document.getElementById('listingPrice');
        const listingDescription = document.getElementById('listingDescription');
        const createListingBtn = document.getElementById('createListingBtn');
        const refreshTransactionsBtn = document.getElementById('refreshTransactionsBtn');
        const transactionsList = document.getElementById('transactionsList');
        const listingModal = document.getElementById('listingModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const quantityInfo = document.getElementById('quantityInfo');

        // Initialize game
        function initGame() {
            // Check if user is already logged in
            const currentUser = JSON.parse(localStorage.getItem('currentMiningUser_v2'));
            if (currentUser) {
                loginSuccess(currentUser);
            }
            
            // Initialize item rates
            updateRatesByDepth();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize market filters
            initMarketFilters();
            
            // Load initial data
            loadLeaderboard();
            loadChatMessages();
            loadMarketListings();
            loadMyListings();
            loadTransactions();
            
            // Update online count
            updateOnlineCount();
            
            // Update quantity info
            updateQuantityInfoDisplay();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth events
            loginBtn.addEventListener('click', handleLogin);
            registerBtn.addEventListener('click', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);
            showRegister.addEventListener('click', () => switchAuthForm('register'));
            showLogin.addEventListener('click', () => switchAuthForm('login'));
            
            // Game events
            digBtn.addEventListener('click', dig);
            upBtn.addEventListener('click', moveUp);
            downBtn.addEventListener('click', moveDown);
            
            // Inventory events
            sellAllBtn.addEventListener('click', sellAllItems);
            openCreateListingBtn.addEventListener('click', () => {
                switchTab('market');
                switchMarketTab('create');
            });
            
            // Market events
            marketTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-market-tab');
                    switchMarketTab(tabId);
                });
            });
            
            applyFiltersBtn.addEventListener('click', loadMarketListings);
            createListingBtn.addEventListener('click', handleCreateListing);
            
            // Transactions events
            refreshTransactionsBtn.addEventListener('click', loadTransactions);
            
            // Chat events
            sendChatBtn.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // Tab events
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                    
                    // Refresh data when switching to certain tabs
                    if (tabId === 'market') {
                        loadMarketListings();
                        loadMyListings();
                    } else if (tabId === 'transactions') {
                        loadTransactions();
                    }
                });
            });
            
            // Modal events
            closeModal.addEventListener('click', () => {
                listingModal.classList.remove('active');
            });
            
            // Close modal when clicking outside
            listingModal.addEventListener('click', (e) => {
                if (e.target === listingModal) {
                    listingModal.classList.remove('active');
                }
            });
            
            // Real-time validation for create listing form
            listingItem.addEventListener('change', updateQuantityInfoDisplay);
            listingQuantity.addEventListener('input', updateQuantityInfoDisplay);
        }

        // Initialize market filters
        function initMarketFilters() {
            // Populate item filter options
            filterItem.innerHTML = '<option value="">T·∫•t c·∫£ v·∫≠t ph·∫©m</option>';
            listingItem.innerHTML = '<option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>';
            
            items.forEach(item => {
                filterItem.innerHTML += `<option value="${item.id}">${item.icon} ${item.name}</option>`;
                
                // For create listing form - show inventory info
                const hasItem = gameState.inventory[item.id] > 0;
                const disabledAttr = !hasItem ? 'disabled' : '';
                const stockInfo = hasItem ? ` (C√≥ ${gameState.inventory[item.id]} trong kho)` : ' (H·∫øt h√†ng)';
                listingItem.innerHTML += `<option value="${item.id}" ${disabledAttr}>${item.icon} ${item.name}${stockInfo}</option>`;
            });
        }

        // Update quantity info display
        function updateQuantityInfoDisplay() {
            const selectedItem = listingItem.value;
            const quantity = parseInt(listingQuantity.value) || 0;
            
            if (!selectedItem) {
                quantityInfo.innerHTML = 'Vui l√≤ng ch·ªçn v·∫≠t ph·∫©m';
                quantityInfo.style.color = '#AAA';
                createListingBtn.disabled = false;
                return;
            }
            
            const availableQuantity = gameState.inventory[selectedItem] || 0;
            const item = items.find(i => i.id === selectedItem);
            
            if (availableQuantity <= 0) {
                quantityInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> B·∫°n kh√¥ng c√≥ ${item.name} trong kho!`;
                quantityInfo.style.color = 'var(--danger-color)';
                createListingBtn.disabled = true;
            } else if (quantity > availableQuantity) {
                quantityInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> B·∫°n ch·ªâ c√≥ ${availableQuantity} ${item.name}, kh√¥ng ƒë·ªß s·ªë l∆∞·ª£ng!`;
                quantityInfo.style.color = 'var(--danger-color)';
                createListingBtn.disabled = true;
            } else if (quantity <= 0) {
                quantityInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!`;
                quantityInfo.style.color = 'var(--danger-color)';
                createListingBtn.disabled = true;
            } else {
                quantityInfo.innerHTML = `<i class="fas fa-check-circle"></i> B·∫°n c√≥ ${availableQuantity} ${item.name} trong kho. C√≥ th·ªÉ b√°n ${quantity} c√°i.`;
                quantityInfo.style.color = 'var(--success-color)';
                createListingBtn.disabled = false;
            }
        }

        // Auth functions
        function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showNotification('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }
            
            const user = GameDatabase.findUser(username);
            
            if (user && user.password === password) {
                loginSuccess(user);
                showNotification(`Ch√†o m·ª´ng ${username} quay tr·ªü l·∫°i!`, 'success');
            } else {
                showNotification('T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!', 'error');
            }
        }

        function handleRegister() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!username || !password || !confirmPassword) {
                showNotification('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!', 'error');
                return;
            }
            
            if (username.length < 3) {
                showNotification('T√™n ƒëƒÉng nh·∫≠p ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±!', 'error');
                return;
            }
            
            if (password.length < 4) {
                showNotification('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 4 k√Ω t·ª±!', 'error');
                return;
            }
            
            if (GameDatabase.findUser(username)) {
                showNotification('T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!', 'error');
                return;
            }
            
            const newUser = {
                username,
                password,
                balance: 100, // Starting balance
                inventory: { ...gameState.inventory },
                totalEarned: 0,
                joinDate: new Date().toISOString(),
                marketListings: []
            };
            
            GameDatabase.users.push(newUser);
            GameDatabase.saveUsers();
            
            showNotification('ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c 100 xu.', 'success');
            switchAuthForm('login');
            document.getElementById('loginUsername').value = username;
            document.getElementById('loginPassword').value = password;
        }

        function loginSuccess(user) {
            gameState.loggedIn = true;
            gameState.username = user.username;
            gameState.balance = user.balance;
            gameState.inventory = { ...user.inventory };
            
            // Save current user to localStorage
            localStorage.setItem('currentMiningUser_v2', JSON.stringify(user));
            
            // Update UI
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');
            gameContent.style.display = 'block';
            logoutBtn.style.display = 'block';
            balanceAmount.textContent = gameState.balance;
            
            // Update inventory display
            updateInventoryDisplay();
            
            // Add welcome chat message
            addChatMessage('H·ªá th·ªëng', `${user.username} ƒë√£ tham gia tr√≤ chuy·ªán!`, true);
        }

        function handleLogout() {
            // Save user data
            GameDatabase.updateUser(gameState.username, {
                balance: gameState.balance,
                inventory: { ...gameState.inventory }
            });
            
            // Add leave chat message
            addChatMessage('H·ªá th·ªëng', `${gameState.username} ƒë√£ r·ªùi kh·ªèi tr√≤ chuy·ªán!`, true);
            
            // Reset game state
            gameState.loggedIn = false;
            gameState.username = '';
            gameState.balance = 0;
            gameState.depth = 0;
            gameState.inventory = {
                worm: 0,
                gold: 0,
                silver: 0,
                diamond: 0,
                corpse: 0,
                mouse: 0,
                grass: 0
            };
            
            // Update UI
            gameContent.style.display = 'none';
            logoutBtn.style.display = 'none';
            loginForm.classList.add('active');
            
            // Clear current user
            localStorage.removeItem('currentMiningUser_v2');
            
            // Reset forms
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerConfirmPassword').value = '';
            
            showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
        }

        function switchAuthForm(form) {
            if (form === 'register') {
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
            } else {
                registerForm.classList.remove('active');
                loginForm.classList.add('active');
            }
        }

        // Game functions
        function updateRatesByDepth() {
            const depth = gameState.depth;
            let commonMod = 0;
            let rareMod = 0;
            let epicMod = 0;
            
            if (depth <= 100) {
                gameState.zone = '0-100m';
                commonMod = 5;
                rareMod = -2;
                epicMod = -2;
            } else if (depth <= 500) {
                gameState.zone = '100-500m';
                commonMod = -30;
                rareMod = 10;
                epicMod = 8;
            } else {
                gameState.zone = '500m+';
                commonMod = -50;
                rareMod = 20;
                epicMod = 15;
            }
            
            // Apply modifications
            gameState.currentRates = { ...gameState.baseRates };
            
            // Common items: worm, corpse, mouse, grass
            gameState.currentRates.worm = Math.max(0, gameState.baseRates.worm + commonMod);
            gameState.currentRates.corpse = Math.max(0, gameState.baseRates.corpse + commonMod);
            gameState.currentRates.mouse = Math.max(0, gameState.baseRates.mouse + commonMod);
            gameState.currentRates.grass = Math.max(0, gameState.baseRates.grass + commonMod);
            
            // Rare items: gold, silver
            gameState.currentRates.gold = Math.max(0, gameState.baseRates.gold + rareMod);
            gameState.currentRates.silver = Math.max(0, gameState.baseRates.silver + rareMod);
            
            // Epic item: diamond
            gameState.currentRates.diamond = Math.max(0, gameState.baseRates.diamond + epicMod);
            
            // Update UI
            currentZone.textContent = gameState.zone;
        }

        function dig() {
            if (!gameState.loggedIn || gameState.mining) return;
            
            gameState.mining = true;
            digBtn.disabled = true;
            
            // Show mining animation
            digBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Determine what item is found based on rates
            const totalRate = Object.values(gameState.currentRates).reduce((a, b) => a + b, 0);
            let randomValue = Math.random() * totalRate;
            
            let foundItem = null;
            for (const [itemId, rate] of Object.entries(gameState.currentRates)) {
                if (randomValue <= rate) {
                    foundItem = itemId;
                    break;
                }
                randomValue -= rate;
            }
            
            // If no item found (shouldn't happen), default to grass
            if (!foundItem) foundItem = 'grass';
            
            // Add item to inventory
            gameState.inventory[foundItem]++;
            
            // Update user data in database
            GameDatabase.updateUser(gameState.username, {
                inventory: { ...gameState.inventory }
            });
            
            // Show item animation in game area
            showItemAnimation(foundItem);
            
            // Update inventory display
            updateInventoryDisplay();
            
            // Update leaderboard
            updateLeaderboard();
            
            // Show notification
            const itemName = items.find(item => item.id === foundItem).name;
            const itemPrice = gameState.itemPrices[foundItem];
            showNotification(`B·∫°n ƒë√£ ƒë√†o ƒë∆∞·ª£c ${itemName}! Gi√° tr·ªã: ${itemPrice} xu`, 'success');
            
            // Reset mining state after delay
            setTimeout(() => {
                gameState.mining = false;
                digBtn.disabled = false;
                digBtn.innerHTML = '<i class="fas fa-digging"></i>';
            }, 1000);
        }

        function showItemAnimation(itemId) {
            const item = items.find(i => i.id === itemId);
            const itemElement = document.createElement('div');
            itemElement.className = `item ${itemId}`;
            itemElement.innerHTML = item.icon;
            itemElement.style.left = `${50 + (Math.random() * 30 - 15)}%`;
            itemElement.style.bottom = `${50 + (Math.random() * 10)}%`;
            
            gameArea.appendChild(itemElement);
            
            // Trigger animation
            setTimeout(() => {
                itemElement.classList.add('show');
            }, 10);
            
            // Remove after animation
            setTimeout(() => {
                itemElement.classList.remove('show');
                setTimeout(() => {
                    if (itemElement.parentNode) {
                        gameArea.removeChild(itemElement);
                    }
                }, 300);
            }, 2000);
        }

        function moveUp() {
            if (!gameState.loggedIn || gameState.mining) return;
            
            gameState.depth = Math.max(0, gameState.depth - 10);
            updateDepthDisplay();
            updateRatesByDepth();
        }

        function moveDown() {
            if (!gameState.loggedIn || gameState.mining) return;
            
            gameState.depth += 10;
            updateDepthDisplay();
            updateRatesByDepth();
        }

        function updateDepthDisplay() {
            currentDepth.textContent = gameState.depth;
            
            // Update depth meter (max depth: 600m for display purposes)
            const depthPercent = Math.min(100, (gameState.depth / 600) * 100);
            depthFill.style.width = `${depthPercent}%`;
            
            // Update miner position
            const minerBottom = 50 - (gameState.depth / 600) * 40;
            miner.style.bottom = `${minerBottom}%`;
        }

        // Inventory functions
        function updateInventoryDisplay() {
            inventoryItems.innerHTML = '';
            
            items.forEach(item => {
                const count = gameState.inventory[item.id];
                const price = gameState.itemPrices[item.id];
                
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.innerHTML = `
                    <div class="item-icon ${item.id}" style="background: ${item.color}">
                        ${item.icon}
                    </div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-count">${count}</div>
                    <div class="item-price">${price} xu/chi·∫øc</div>
                    <div class="item-actions">
                        <button class="action-btn sell-btn" data-item="${item.id}">
                            <i class="fas fa-money-bill-wave"></i> B√°n
                        </button>
                        <button class="action-btn list-btn" data-item="${item.id}">
                            <i class="fas fa-store"></i> ƒêƒÉng b√°n
                        </button>
                    </div>
                `;
                
                // Add event listeners to action buttons
                const sellBtn = itemElement.querySelector('.sell-btn');
                sellBtn.addEventListener('click', () => sellItem(item.id));
                
                const listBtn = itemElement.querySelector('.list-btn');
                listBtn.addEventListener('click', () => {
                    if (count > 0) {
                        switchTab('market');
                        switchMarketTab('create');
                        listingItem.value = item.id;
                        listingQuantity.value = 1;
                        listingPrice.value = Math.max(10, Math.floor(price * 1.5));
                        updateQuantityInfoDisplay();
                    } else {
                        showNotification(`B·∫°n kh√¥ng c√≥ ${item.name} ƒë·ªÉ ƒëƒÉng b√°n!`, 'error');
                    }
                });
                
                inventoryItems.appendChild(itemElement);
            });
            
            // Update balance display
            balanceAmount.textContent = gameState.balance;
            
            // Update market filters
            initMarketFilters();
            updateQuantityInfoDisplay();
        }

        function sellItem(itemId) {
            const count = gameState.inventory[itemId];
            if (count <= 0) {
                showNotification(`B·∫°n kh√¥ng c√≥ ${items.find(i => i.id === itemId).name} ƒë·ªÉ b√°n!`, 'error');
                return;
            }
            
            const price = gameState.itemPrices[itemId];
            const total = count * price;
            
            gameState.balance += total;
            gameState.inventory[itemId] = 0;
            
            // Update user data in database
            GameDatabase.updateUser(gameState.username, {
                balance: gameState.balance,
                inventory: { ...gameState.inventory }
            });
            
            // Update leaderboard with earnings
            updateLeaderboard();
            
            // Record transaction
            const transaction = {
                id: 'tx_' + Date.now() + Math.random().toString(36).substr(2, 9),
                type: 'sell_to_system',
                itemId: itemId,
                itemName: items.find(i => i.id === itemId).name,
                quantity: count,
                pricePerItem: price,
                totalAmount: total,
                seller: gameState.username,
                buyer: 'H·ªá th·ªëng',
                timestamp: new Date().toISOString()
            };
            
            GameDatabase.addTransaction(transaction);
            
            showNotification(`B√°n th√†nh c√¥ng ${count} ${items.find(i => i.id === itemId).name} ƒë∆∞·ª£c ${total} xu!`, 'success');
            updateInventoryDisplay();
        }

        function sellAllItems() {
            let totalEarned = 0;
            let itemsSold = [];
            
            Object.keys(gameState.inventory).forEach(itemId => {
                const count = gameState.inventory[itemId];
                if (count > 0) {
                    const price = gameState.itemPrices[itemId];
                    const total = count * price;
                    totalEarned += total;
                    itemsSold.push({ 
                        itemId, 
                        name: items.find(i => i.id === itemId).name, 
                        count, 
                        total 
                    });
                    gameState.inventory[itemId] = 0;
                }
            });
            
            if (totalEarned === 0) {
                showNotification('Kh√¥ng c√≥ v·∫≠t ph·∫©m n√†o ƒë·ªÉ b√°n!', 'error');
                return;
            }
            
            gameState.balance += totalEarned;
            
            // Update user data in database
            GameDatabase.updateUser(gameState.username, {
                balance: gameState.balance,
                inventory: { ...gameState.inventory }
            });
            
            // Update leaderboard with earnings
            updateLeaderboard();
            
            // Record transactions
            itemsSold.forEach(item => {
                const transaction = {
                    id: 'tx_' + Date.now() + Math.random().toString(36).substr(2, 9),
                    type: 'sell_to_system',
                    itemId: item.itemId,
                    itemName: item.name,
                    quantity: item.count,
                    pricePerItem: item.total / item.count,
                    totalAmount: item.total,
                    seller: gameState.username,
                    buyer: 'H·ªá th·ªëng',
                    timestamp: new Date().toISOString()
                };
                
                GameDatabase.addTransaction(transaction);
            });
            
            showNotification(`B√°n t·∫•t c·∫£ th√†nh c√¥ng! Thu ƒë∆∞·ª£c ${totalEarned} xu`, 'success');
            updateInventoryDisplay();
        }

        // Market functions
        function loadMarketListings() {
            let filteredListings = [...GameDatabase.listings];
            
            // Filter by item
            const selectedItem = filterItem.value;
            if (selectedItem) {
                filteredListings = filteredListings.filter(l => l.itemId === selectedItem);
            }
            
            // Filter out sold listings
            filteredListings = filteredListings.filter(l => !l.sold && !l.cancelled);
            
            // Sort listings
            const sortOption = filterSort.value;
            switch (sortOption) {
                case 'price_asc':
                    filteredListings.sort((a, b) => a.price - b.price);
                    break;
                case 'price_desc':
                    filteredListings.sort((a, b) => b.price - a.price);
                    break;
                case 'date_desc':
                    filteredListings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'date_asc':
                    filteredListings.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
            }
            
            // Update market stats
            marketStats.textContent = `ƒêang c√≥ ${filteredListings.length} tin rao b√°n`;
            
            // Display listings
            marketListings.innerHTML = '';
            
            if (filteredListings.length === 0) {
                marketListings.innerHTML = `
                    <div class="no-listings">
                        <i class="fas fa-store-slash fa-3x" style="margin-bottom: 10px;"></i>
                        <p>Kh√¥ng c√≥ tin rao b√°n n√†o!</p>
                        <p style="font-size: 12px;">H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒëƒÉng tin b√°n v·∫≠t ph·∫©m</p>
                    </div>
                `;
                return;
            }
            
            filteredListings.forEach(listing => {
                const item = items.find(i => i.id === listing.itemId);
                const listingElement = document.createElement('div');
                listingElement.className = 'listing-item';
                listingElement.innerHTML = `
                    <div class="listing-info">
                        <div class="item-icon ${listing.itemId}" style="background: ${item.color}">
                            ${item.icon}
                        </div>
                        <div class="listing-details">
                            <div style="font-weight: bold;">${item.name} x${listing.quantity}</div>
                            <div class="listing-seller">Ng∆∞·ªùi b√°n: ${listing.seller}</div>
                            <div style="font-size: 12px; margin-top: 5px;">${listing.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</div>
                        </div>
                    </div>
                    <div class="listing-actions">
                        <div style="text-align: right;">
                            <div class="listing-price">${listing.price} xu/c√°i</div>
                            <div style="font-size: 12px; color: #AAA;">T·ªïng: ${listing.price * listing.quantity} xu</div>
                        </div>
                        <button class="btn btn-sm btn-success buy-btn" data-listing-id="${listing.id}" style="margin-left: 10px;">
                            <i class="fas fa-shopping-cart"></i> Mua
                        </button>
                    </div>
                `;
                
                // Add event listener to buy button
                const buyBtn = listingElement.querySelector('.buy-btn');
                buyBtn.addEventListener('click', () => showListingModal(listing.id));
                
                marketListings.appendChild(listingElement);
            });
        }

        function loadMyListings() {
            const myListings = GameDatabase.listings.filter(l => 
                l.seller === gameState.username && !l.sold && !l.cancelled
            );
            
            myListingsContainer.innerHTML = '';
            
            if (myListings.length === 0) {
                myListingsContainer.innerHTML = `
                    <div class="no-listings">
                        <i class="fas fa-clipboard-list fa-3x" style="margin-bottom: 10px;"></i>
                        <p>B·∫°n ch∆∞a c√≥ tin rao b√°n n√†o!</p>
                        <p style="font-size: 12px;">H√£y ƒëƒÉng tin b√°n v·∫≠t ph·∫©m c·ªßa b·∫°n</p>
                    </div>
                `;
                return;
            }
            
            myListings.forEach(listing => {
                const item = items.find(i => i.id === listing.itemId);
                const listingElement = document.createElement('div');
                listingElement.className = 'listing-item';
                listingElement.innerHTML = `
                    <div class="listing-info">
                        <div class="item-icon ${listing.itemId}" style="background: ${item.color}">
                            ${item.icon}
                        </div>
                        <div class="listing-details">
                            <div style="font-weight: bold;">${item.name} x${listing.quantity}</div>
                            <div style="font-size: 12px; color: #AAA;">
                                ƒêƒÉng ng√†y: ${new Date(listing.createdAt).toLocaleDateString('vi-VN')}
                            </div>
                            <div style="font-size: 12px; margin-top: 5px;">${listing.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</div>
                        </div>
                    </div>
                    <div class="listing-actions">
                        <div style="text-align: right;">
                            <div class="listing-price">${listing.price} xu/c√°i</div>
                            <div style="font-size: 12px; color: #AAA;">T·ªïng: ${listing.price * listing.quantity} xu</div>
                        </div>
                        <div style="display: flex; gap: 5px; margin-left: 10px;">
                            <button class="btn btn-sm btn-secondary cancel-btn" data-listing-id="${listing.id}">
                                <i class="fas fa-times"></i> H·ªßy
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listener to cancel button
                const cancelBtn = listingElement.querySelector('.cancel-btn');
                cancelBtn.addEventListener('click', () => cancelListing(listing.id));
                
                myListingsContainer.appendChild(listingElement);
            });
        }

        function handleCreateListing() {
            if (!gameState.loggedIn) {
                showNotification('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng tin b√°n!', 'error');
                return;
            }
            
            const itemId = listingItem.value;
            const quantity = parseInt(listingQuantity.value);
            const price = parseInt(listingPrice.value);
            const description = listingDescription.value.trim();
            
            // Validate inputs
            if (!itemId) {
                showNotification('Vui l√≤ng ch·ªçn v·∫≠t ph·∫©m!', 'error');
                return;
            }
            
            if (!quantity || quantity < 1) {
                showNotification('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!', 'error');
                return;
            }
            
            if (!price || price < 1) {
                showNotification('Gi√° ph·∫£i l·ªõn h∆°n 0!', 'error');
                return;
            }
            
            // Check if user has enough items
            const availableQuantity = gameState.inventory[itemId];
            if (availableQuantity < quantity) {
                const itemName = items.find(i => i.id === itemId).name;
                showNotification(`B·∫°n ch·ªâ c√≥ ${availableQuantity} ${itemName}, kh√¥ng ƒë·ªß ƒë·ªÉ ƒëƒÉng b√°n ${quantity} c√°i!`, 'error');
                return;
            }
            
            // Create listing
            const listing = {
                id: 'lst_' + Date.now() + Math.random().toString(36).substr(2, 9),
                itemId: itemId,
                quantity: quantity,
                price: price,
                description: description,
                seller: gameState.username,
                createdAt: new Date().toISOString(),
                sold: false,
                cancelled: false,
                buyer: null,
                soldAt: null
            };
            
            // Deduct items from inventory
            gameState.inventory[itemId] -= quantity;
            
            // Update user data in database
            GameDatabase.updateUser(gameState.username, {
                inventory: { ...gameState.inventory }
            });
            
            // Add listing to database
            GameDatabase.addListing(listing);
            
            // Update inventory display
            updateInventoryDisplay();
            
            // Switch to my listings tab
            switchMarketTab('myListings');
            loadMyListings();
            
            // Show success notification
            const itemName = items.find(i => i.id === itemId).name;
            showNotification(`ƒê√£ ƒëƒÉng b√°n ${quantity} ${itemName} v·ªõi gi√° ${price} xu/c√°i!`, 'success');
            
            // Reset form
            listingItem.value = '';
            listingQuantity.value = 1;
            listingPrice.value = 10;
            listingDescription.value = '';
            updateQuantityInfoDisplay();
        }

        function cancelListing(listingId) {
            const listing = GameDatabase.findListing(listingId);
            
            if (!listing) {
                showNotification('Tin rao kh√¥ng t·ªìn t·∫°i!', 'error');
                return;
            }
            
            if (listing.seller !== gameState.username) {
                showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy tin rao n√†y!', 'error');
                return;
            }
            
            if (listing.sold) {
                showNotification('Tin rao ƒë√£ ƒë∆∞·ª£c b√°n, kh√¥ng th·ªÉ h·ªßy!', 'error');
                return;
            }
            
            // Mark listing as cancelled
            GameDatabase.updateListing(listingId, {
                cancelled: true
            });
            
            // Return items to inventory
            gameState.inventory[listing.itemId] += listing.quantity;
            
            // Update user data in database
            GameDatabase.updateUser(gameState.username, {
                inventory: { ...gameState.inventory }
            });
            
            // Update inventory display
            updateInventoryDisplay();
            
            // Reload my listings
            loadMyListings();
            
            // Show notification
            const itemName = items.find(i => i.id === listing.itemId).name;
            showNotification(`ƒê√£ h·ªßy tin rao b√°n ${listing.quantity} ${itemName}!`, 'success');
        }

        function showListingModal(listingId) {
            const listing = GameDatabase.findListing(listingId);
            
            if (!listing) {
                showNotification('Tin rao kh√¥ng t·ªìn t·∫°i!', 'error');
                return;
            }
            
            if (listing.sold) {
                showNotification('Tin rao ƒë√£ ƒë∆∞·ª£c b√°n!', 'error');
                return;
            }
            
            if (listing.cancelled) {
                showNotification('Tin rao ƒë√£ b·ªã h·ªßy!', 'error');
                return;
            }
            
            if (listing.seller === gameState.username) {
                showNotification('B·∫°n kh√¥ng th·ªÉ mua v·∫≠t ph·∫©m c·ªßa ch√≠nh m√¨nh!', 'error');
                return;
            }
            
            const item = items.find(i => i.id === listing.itemId);
            const totalPrice = listing.price * listing.quantity;
            
            modalTitle.textContent = `Mua ${item.name}`;
            modalContent.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div class="item-icon ${item.id}" style="width: 60px; height: 60px; font-size: 28px; background: ${item.color}">
                        ${item.icon}
                    </div>
                    <div>
                        <h4 style="margin-bottom: 5px;">${item.name} x${listing.quantity}</h4>
                        <div style="font-size: 14px; color: #AAA;">Ng∆∞·ªùi b√°n: ${listing.seller}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Gi√° m·ªói c√°i:</span>
                        <span style="font-weight: bold; color: var(--accent-color);">${listing.price} xu</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>S·ªë l∆∞·ª£ng:</span>
                        <span>${listing.quantity}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>T·ªïng ti·ªÅn:</span>
                        <span style="font-weight: bold; color: var(--accent-color); font-size: 18px;">${totalPrice} xu</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>S·ªë d∆∞ c·ªßa b·∫°n:</span>
                        <span style="color: ${gameState.balance >= totalPrice ? 'var(--success-color)' : 'var(--danger-color)'}">
                            ${gameState.balance} xu
                        </span>
                    </div>
                </div>
                
                ${listing.description ? `
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">M√¥ t·∫£:</div>
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; font-size: 14px;">
                            ${listing.description}
                        </div>
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="cancelPurchaseBtn" style="flex: 1;">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button class="btn btn-success" id="confirmPurchaseBtn" style="flex: 2;" 
                            ${gameState.balance < totalPrice ? 'disabled' : ''}>
                        <i class="fas fa-shopping-cart"></i> X√°c nh·∫≠n mua
                    </button>
                </div>
                
                ${gameState.balance < totalPrice ? `
                    <div style="margin-top: 10px; color: var(--danger-color); font-size: 12px; text-align: center;">
                        <i class="fas fa-exclamation-triangle"></i> B·∫°n kh√¥ng ƒë·ªß xu ƒë·ªÉ mua v·∫≠t ph·∫©m n√†y!
                    </div>
                ` : ''}
            `;
            
            // Add event listeners to modal buttons
            document.getElementById('cancelPurchaseBtn').addEventListener('click', () => {
                listingModal.classList.remove('active');
            });
            
            document.getElementById('confirmPurchaseBtn').addEventListener('click', () => {
                purchaseListing(listingId);
            });
            
            listingModal.classList.add('active');
        }

        function purchaseListing(listingId) {
            const listing = GameDatabase.findListing(listingId);
            const totalPrice = listing.price * listing.quantity;
            
            // Check if user has enough balance
            if (gameState.balance < totalPrice) {
                showNotification('B·∫°n kh√¥ng ƒë·ªß xu ƒë·ªÉ mua v·∫≠t ph·∫©m n√†y!', 'error');
                return;
            }
            
            // Get seller info
            const seller = GameDatabase.findUser(listing.seller);
            if (!seller) {
                showNotification('Ng∆∞·ªùi b√°n kh√¥ng t·ªìn t·∫°i!', 'error');
                return;
            }
            
            // Update buyer balance
            gameState.balance -= totalPrice;
            
            // Update seller balance
            const sellerNewBalance = seller.balance + totalPrice;
            GameDatabase.updateUser(listing.seller, {
                balance: sellerNewBalance
            });
            
            // Add item to buyer's inventory
            gameState.inventory[listing.itemId] += listing.quantity;
            
            // Update buyer data in database
            GameDatabase.updateUser(gameState.username, {
                balance: gameState.balance,
                inventory: { ...gameState.inventory }
            });
            
            // Mark listing as sold
            GameDatabase.updateListing(listingId, {
                sold: true,
                buyer: gameState.username,
                soldAt: new Date().toISOString()
            });
            
            // Record transaction
            const transaction = {
                id: 'tx_' + Date.now() + Math.random().toString(36).substr(2, 9),
                type: 'player_to_player',
                itemId: listing.itemId,
                itemName: items.find(i => i.id === listing.itemId).name,
                quantity: listing.quantity,
                pricePerItem: listing.price,
                totalAmount: totalPrice,
                seller: listing.seller,
                buyer: gameState.username,
                listingId: listingId,
                timestamp: new Date().toISOString()
            };
            
            GameDatabase.addTransaction(transaction);
            
            // Update leaderboard
            updateLeaderboard();
            
            // Update UI
            updateInventoryDisplay();
            loadMarketListings();
            loadMyListings();
            
            // Close modal
            listingModal.classList.remove('active');
            
            // Show success notification
            const itemName = items.find(i => i.id === listing.itemId).name;
            showNotification(`Mua th√†nh c√¥ng ${listing.quantity} ${itemName} v·ªõi gi√° ${totalPrice} xu!`, 'success');
            
            // Add chat notification
            addChatMessage('H·ªá th·ªëng', `${gameState.username} ƒë√£ mua ${listing.quantity} ${itemName} t·ª´ ${listing.seller} v·ªõi gi√° ${totalPrice} xu!`, true);
        }

        // Transactions functions
        function loadTransactions() {
            const userTransactions = GameDatabase.getUserTransactions(gameState.username);
            
            transactionsList.innerHTML = '';
            
            if (userTransactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="no-listings">
                        <i class="fas fa-history fa-3x" style="margin-bottom: 10px;"></i>
                        <p>Ch∆∞a c√≥ giao d·ªãch n√†o!</p>
                        <p style="font-size: 12px;">Giao d·ªãch c·ªßa b·∫°n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                    </div>
                `;
                return;
            }
            
            userTransactions.forEach(transaction => {
                const item = items.find(i => i.id === transaction.itemId);
                const isBuyer = transaction.buyer === gameState.username;
                const isSeller = transaction.seller === gameState.username;
                const isSystem = transaction.buyer === 'H·ªá th·ªëng';
                
                const transactionElement = document.createElement('div');
                transactionElement.className = 'listing-item';
                transactionElement.innerHTML = `
                    <div class="listing-info">
                        <div class="item-icon ${transaction.itemId}" style="background: ${item.color}">
                            ${item.icon}
                        </div>
                        <div class="listing-details">
                            <div style="font-weight: bold;">${item.name} x${transaction.quantity}</div>
                            <div style="font-size: 12px; color: #AAA;">
                                ${new Date(transaction.timestamp).toLocaleString('vi-VN')}
                            </div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                ${isSystem ? 'B√°n cho h·ªá th·ªëng' : 
                                  isBuyer ? `Mua t·ª´ ${transaction.seller}` : 
                                  `B√°n cho ${transaction.buyer}`}
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: ${isSeller || isSystem ? 'var(--success-color)' : 'var(--danger-color)'}; font-size: 18px;">
                            ${isSeller || isSystem ? '+' : '-'}${transaction.totalAmount} xu
                        </div>
                        <div style="font-size: 12px; color: #AAA;">
                            ${transaction.pricePerItem} xu/c√°i
                        </div>
                    </div>
                `;
                
                transactionsList.appendChild(transactionElement);
            });
        }

        // Leaderboard functions
        function loadLeaderboard() {
            // In a real app, this would load from server
            // For demo, we'll generate mock data if empty
            if (GameDatabase.leaderboard.length === 0) {
                GameDatabase.leaderboard = [
                    { username: 'Ng∆∞·ªùi ch∆°i 1', balance: 12500, totalEarned: 25000 },
                    { username: 'Ng∆∞·ªùi ch∆°i 2', balance: 9800, totalEarned: 19800 },
                    { username: 'Ng∆∞·ªùi ch∆°i 3', balance: 7600, totalEarned: 17600 },
                    { username: 'Ng∆∞·ªùi ch∆°i 4', balance: 5400, totalEarned: 12400 },
                    { username: 'Ng∆∞·ªùi ch∆°i 5', balance: 3200, totalEarned: 9200 }
                ];
                GameDatabase.saveLeaderboard();
            }
            
            updateLeaderboardDisplay();
        }

        function updateLeaderboard() {
            // Find current user in leaderboard or add them
            const userIndex = GameDatabase.leaderboard.findIndex(u => u.username === gameState.username);
            
            if (userIndex !== -1) {
                // Update existing user
                GameDatabase.leaderboard[userIndex].balance = gameState.balance;
                // Calculate total earned (simplified)
                GameDatabase.leaderboard[userIndex].totalEarned = Math.max(
                    GameDatabase.leaderboard[userIndex].totalEarned,
                    gameState.balance * 2
                );
            } else if (gameState.loggedIn) {
                // Add new user
                GameDatabase.leaderboard.push({
                    username: gameState.username,
                    balance: gameState.balance,
                    totalEarned: gameState.balance * 2
                });
            }
            
            // Sort by balance (descending)
            GameDatabase.leaderboard.sort((a, b) => b.balance - a.balance);
            
            // Keep only top 10
            GameDatabase.leaderboard = GameDatabase.leaderboard.slice(0, 10);
            
            // Save to database
            GameDatabase.saveLeaderboard();
            
            // Update display
            updateLeaderboardDisplay();
        }

        function updateLeaderboardDisplay() {
            leaderboard.innerHTML = '';
            
            GameDatabase.leaderboard.forEach((user, index) => {
                const rank = index + 1;
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = `leaderboard-item ${rank <= 3 ? `top-${rank}` : ''}`;
                
                leaderboardItem.innerHTML = `
                    <div class="rank">${rank}</div>
                    <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                    <div class="user-details">
                        <div class="user-name">${user.username}</div>
                        <div class="user-stats">
                            <i class="fas fa-coins"></i> ${user.balance.toLocaleString()} xu |
                            <i class="fas fa-trophy"></i> ${user.totalEarned.toLocaleString()} xu t·ªïng
                        </div>
                    </div>
                `;
                
                leaderboard.appendChild(leaderboardItem);
            });
            
            // Add prize notification for top 3
            if (GameDatabase.leaderboard.length >= 3) {
                const prizeInfo = document.createElement('div');
                prizeInfo.style.background = 'rgba(255, 215, 0, 0.1)';
                prizeInfo.style.padding = '10px';
                prizeInfo.style.borderRadius = '10px';
                prizeInfo.style.marginTop = '15px';
                prizeInfo.style.fontSize = '12px';
                prizeInfo.innerHTML = `
                    <div style="color: #FFD700; font-weight: bold;">
                        <i class="fas fa-award"></i> PH·∫¶N TH∆Ø·ªûNG TOP 3 H√îM NAY
                    </div>
                    <div style="margin-top: 5px;">
                        Top 1: ${GameDatabase.leaderboard[0].username} - 50,000 VND<br>
                        Top 2: ${GameDatabase.leaderboard[1].username} - 50,000 VND<br>
                        Top 3: ${GameDatabase.leaderboard[2].username} - 50,000 VND
                    </div>
                    <div style="margin-top: 5px; color: #AAA; font-size: 10px;">
                        Li√™n h·ªá <a href="https://t.me/cskhh1" style="color: #0088cc;">@cskhh1</a> tr√™n Telegram ƒë·ªÉ nh·∫≠n th∆∞·ªüng
                    </div>
                `;
                leaderboard.appendChild(prizeInfo);
            }
        }

        // Chat functions
        function loadChatMessages() {
            // In a real app, this would load from server
            // For demo, we'll generate initial messages if empty
            if (GameDatabase.chatMessages.length === 0) {
                GameDatabase.chatMessages = [
                    { sender: 'H·ªá th·ªëng', message: 'Ch√†o m·ª´ng ƒë·∫øn v·ªõi game ƒê√†o ƒê√° PRO!', time: '10:00', isSystem: true },
                    { sender: 'H·ªá th·ªëng', message: 'Ch·ª£ giao d·ªãch ƒë√£ m·ªü! H√£y mua b√°n v·∫≠t ph·∫©m v·ªõi ng∆∞·ªùi ch∆°i kh√°c.', time: '10:05', isSystem: true },
                    { sender: 'Ng∆∞·ªùi ch∆°i 1', message: 'Ai c√≥ kim c∆∞∆°ng kh√¥ng? Mua gi√° cao!', time: '10:30', isSystem: false },
                    { sender: 'Ng∆∞·ªùi ch∆°i 2', message: 'M√¨nh v·ª´a b√°n ƒë∆∞·ª£c 10 c·ª•c v√†ng, ki·∫øm ƒë∆∞·ª£c 500 xu!', time: '11:15', isSystem: false },
                    { sender: 'Ng∆∞·ªùi ch∆°i 3', message: 'Ch·ª£ giao d·ªãch r·∫•t ti·ªán l·ª£i, m√¨nh v·ª´a mua ƒë∆∞·ª£c v√†i con chu·ªôt gi√° r·∫ª!', time: '12:45', isSystem: false }
                ];
                GameDatabase.saveChat();
            }
            
            updateChatDisplay();
        }

        function updateChatDisplay() {
            chatMessages.innerHTML = '';
            
            GameDatabase.chatMessages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message';
                messageElement.innerHTML = `
                    <div class="sender">${msg.sender}</div>
                    <div class="message">${msg.message}</div>
                    <div class="time">${msg.time}</div>
                `;
                
                if (msg.isSystem) {
                    messageElement.style.background = 'rgba(0, 78, 137, 0.3)';
                }
                
                chatMessages.appendChild(messageElement);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addChatMessage(sender, message, isSystem = false) {
            const now = new Date();
            const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const newMessage = {
                sender,
                message,
                time,
                isSystem
            };
            
            GameDatabase.chatMessages.push(newMessage);
            
            // Keep only last 50 messages
            if (GameDatabase.chatMessages.length > 50) {
                GameDatabase.chatMessages = GameDatabase.chatMessages.slice(-50);
            }
            
            GameDatabase.saveChat();
            
            updateChatDisplay();
        }

        function sendChatMessage() {
            if (!gameState.loggedIn) {
                showNotification('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i tin nh·∫Øn!', 'error');
                return;
            }
            
            const message = chatInput.value.trim();
            if (!message) {
                showNotification('Vui l√≤ng nh·∫≠p tin nh·∫Øn!', 'error');
                return;
            }
            
            if (message.length > 200) {
                showNotification('Tin nh·∫Øn qu√° d√†i (t·ªëi ƒëa 200 k√Ω t·ª±)!', 'error');
                return;
            }
            
            addChatMessage(gameState.username, message);
            chatInput.value = '';
            
            // Auto-reply for certain keywords (simulated bot)
            setTimeout(() => {
                const msgLower = message.toLowerCase();
                if (msgLower.includes('kim c∆∞∆°ng') || msgLower.includes('diamond')) {
                    addChatMessage('Bot h·ªó tr·ª£', 'Kim c∆∞∆°ng c√≥ t·ªâ l·ªá r∆°i 5% ·ªü ƒë·ªô s√¢u 0-100m v√† tƒÉng d·∫ßn khi ƒë√†o s√¢u h∆°n!', true);
                } else if (msgLower.includes('v√†ng') || msgLower.includes('gold')) {
                    addChatMessage('Bot h·ªó tr·ª£', 'V√†ng c√≥ gi√° 50 xu v√† t·ªâ l·ªá r∆°i 10% ·ªü ƒë·ªô s√¢u 0-100m!', true);
                } else if (msgLower.includes('ch·ª£') || msgLower.includes('market')) {
                    addChatMessage('Bot h·ªó tr·ª£', 'V√†o tab "Ch·ª£ giao d·ªãch" ƒë·ªÉ mua b√°n v·∫≠t ph·∫©m v·ªõi ng∆∞·ªùi ch∆°i kh√°c!', true);
                } else if (msgLower.includes('admin') || msgLower.includes('h·ªó tr·ª£')) {
                    addChatMessage('Bot h·ªó tr·ª£', 'Li√™n h·ªá admin qua Telegram @cskhh1 ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£!', true);
                }
            }, 1000);
        }

        function updateOnlineCount() {
            // Simulate random online count between 50-150
            const onlineCount = Math.floor(Math.random() * 100) + 50;
            document.getElementById('onlineCount').textContent = `ƒêang online: ${onlineCount}`;
            
            // Update every 30 seconds
            setTimeout(updateOnlineCount, 30000);
        }

        // Tab switching functions
        function switchTab(tabId) {
            // Update tabs
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update tab contents
            tabContents.forEach(content => {
                if (content.id === `${tabId}Tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        function switchMarketTab(tabId) {
            // Update market tabs
            marketTabs.forEach(tab => {
                if (tab.getAttribute('data-market-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update market contents
            marketContents.forEach(content => {
                if (content.id === `${tabId}Listings` || content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Utility functions
        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize the game when page loads
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
